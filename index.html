<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium 三维地图可视化</title>
    <!-- 引入Cesium库 -->
    <link rel="stylesheet" href="https://unpkg.com/cesium@1.95.0/Build/Cesium/Widgets/widgets.css">
    <script src="https://unpkg.com/cesium@1.95.0/Build/Cesium/Cesium.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
        .toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .toolbar h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .toolbar button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: white;
            border-radius: 3px;
        }
        .toolbar button:hover {
            background-color: #f0f0f0;
        }
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            display: none;
        }
        .panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }
        .panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .panel .form-group {
            margin-bottom: 10px;
        }
        .panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .panel select, .panel input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .info-panel {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
        .info-panel h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="toolbar">
        <h3>基础控制</h3>
        <button id="resetView">重置视角</button>
        <button id="toggleDebug">显示/隐藏帧率</button>
        <button id="importLocalModel">导入本地模型</button>
        <input type="file" id="fileInput" accept=".json,.gltf,.glb" style="display: none;" />
        <button id="resetStyle">重置样式</button>
    </div>
    
    <div class="panel">
        <h3>3D Tiles 特征样式</h3>
        <div class="form-group">
            <label for="styleSelect">选择样式:</label>
            <select id="styleSelect">
                <option value="original">原始样式</option>
                <option value="height">按高度着色</option>
                <option value="random">随机颜色</option>
                <option value="highlight">高亮选中</option>
                <option value="transparent">半透明</option>
            </select>
        </div>
        <div class="form-group">
            <label for="opacitySlider">透明度:</label>
            <input type="range" id="opacitySlider" min="0" max="1" step="0.1" value="1">
            <span id="opacityValue">1.0</span>
        </div>
        <div class="info-panel">
            <h4>操作提示</h4>
            <p>1. 点击"加载3D模型"按钮加载示例建筑</p>
            <p>2. 使用样式选择器更改模型颜色</p>
            <p>3. 点击模型可查看详细信息</p>
            <p>4. 拖动透明度滑块调整模型透明度</p>
        </div>
    </div>
    
    <div id="statusMessage" class="status-message"></div>
    
    <script>
        // 设置Cesium Ion token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyZjQxODU4Yy1jMWU5LTQ3OTAtYjczZi0wOWJjNjQzMmY3ZDUiLCJpZCI6MzQ4ODgwLCJpYXQiOjE3NjAwNjI2NDZ9.8quAC8y0igLU1g4uQsIKBSMjiVZhZBTIR1hg2Kt5-Ck';
        
        // 初始化Cesium Viewer
        const viewer = new Cesium.Viewer('cesiumContainer', {
            // 使用Cesium内置的世界影像底图
            imageryProvider: Cesium.createWorldImagery({
                style: Cesium.IonWorldImageryStyle.AERIAL
            }),
            
            // 隐藏一些默认控件以保持界面简洁
            homeButton: true,
            sceneModePicker: true,
            navigationHelpButton: true,
            baseLayerPicker: true,
            fullscreenButton: true,
            infoBox: false, // 禁用InfoBox以避免CSS加载错误
            
            // 性能优化设置
            requestRenderMode: true,
            maximumRenderTimeChange: Infinity
        });
        
        // 禁用深度测试以提高性能
        viewer.scene.globe.depthTestAgainstTerrain = false;
        
        // 显示状态消息函数
        function showStatusMessage(message, duration = 3000) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }
        
        // 初始状态消息
        showStatusMessage('系统初始化中...', 1000);
        
        // 启用帧率显示
        viewer.scene.debugShowFramesPerSecond = true;
        
        // 设置初始视角为中国区域
        viewer.camera.setView({
            destination: Cesium.Rectangle.fromDegrees(
                73.5, 18.0, 135.0, 53.5  // 中国区域的大致范围
            )
        });
        
        // 重置视角按钮事件
        document.getElementById('resetView').addEventListener('click', function() {
            try {
                viewer.camera.setView({
                    destination: Cesium.Rectangle.fromDegrees(73.5, 18.0, 135.0, 53.5)
                });
                showStatusMessage('视角已重置', 2000);
            } catch (error) {
                console.error('重置视角失败:', error);
                showStatusMessage('重置视角失败', 2000);
            }
        });
        
        // 帧率显示切换功能
        document.getElementById('toggleDebug').addEventListener('click', function() {
            viewer.scene.debugShowFramesPerSecond = !viewer.scene.debugShowFramesPerSecond;
            showStatusMessage(viewer.scene.debugShowFramesPerSecond ? '帧率显示已开启' : '帧率显示已关闭', 2000);
        });
        
        // 地图瓦片加载进度事件
        viewer.scene.globe.tileLoadProgressEvent.addEventListener(function(progress) {
            if (progress === 0) {
                showStatusMessage('底图加载完成', 2000);
            }
        });
        
        // 3D 模型相关变量
        let tileset = null; // 3D Tiles模型
        let selectedFeature = null; // 选中的特征
        let originalStyle = null; // 原始样式
        let currentModel = null; // 当前加载的模型
        let modelType = null; // 'tileset' 或 'model'
        
        // 导入本地模型功能
        document.getElementById('importLocalModel').addEventListener('click', function() {
            if (currentModel) {
                // 移除当前加载的模型
                if (modelType === 'tileset') {
                    viewer.scene.primitives.remove(tileset);
                    tileset = null;
                } else if (modelType === 'model') {
                    viewer.entities.remove(currentModel);
                    currentModel = null;
                }
                modelType = null;
                showStatusMessage('已移除3D模型', 2000);
                return;
            }
            
            // 触发文件选择对话框
            document.getElementById('fileInput').click();
        });
        
        // 处理文件选择事件
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            try {
                // 创建临时URL
                const fileUrl = URL.createObjectURL(file);
                
                // 处理不同文件格式
                if (fileExtension === 'json') {
                    showStatusMessage(`正在尝试导入3D Tiles文件: ${fileName}...`, 5000);
                    // 提示用户可能遇到的问题
                    showStatusMessage('注意: 3D Tiles格式在本地浏览模式下可能因为浏览器安全策略无法完全加载', 8000);
                    // 尝试加载JSON文件
                    loadLocalTileset(fileUrl, fileName);
                } 
                else if (fileExtension === 'gltf' || fileExtension === 'glb') {
                    showStatusMessage(`正在导入本地模型: ${fileName}...`, 5000);
                    // 加载glTF或glb模型
                    loadLocalGlTFModel(fileUrl, fileName);
                } else {
                    showStatusMessage('不支持的文件格式，请选择.json, .gltf或.glb文件', 3000);
                    // 清理临时URL
                    URL.revokeObjectURL(fileUrl);
                }
                
                // 清空文件输入，允许重新选择同一文件
                this.value = '';
            } catch (error) {
                console.error('导入本地模型时发生错误:', error);
                showStatusMessage('导入本地模型失败: ' + error.message, 5000);
                // 确保清空文件输入
                this.value = '';
            }
        });
        
        // 可选：在HTML中添加文件格式提示
        window.addEventListener('load', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput && !fileInput.title) {
                fileInput.title = '请上传.json(3D Tiles)、.gltf或.glb格式的3D模型文件。JSON文件在本地可能需要特殊配置。';
            }
        });
        
        // 加载本地3D Tiles数据
        function loadLocalTileset(fileUrl, fileName) {
            try {
                showStatusMessage(`正在加载3D Tiles数据: ${fileName}`, 3000);
                
                // 简化的Tileset配置
                const tileset = new Cesium.Cesium3DTileset({
                    url: fileUrl,
                    skipLevelOfDetail: true,
                    maximumScreenSpaceError: 16,
                    maximumNumberOfLoadedTiles: 1000,
                    show: true
                });
                
                // 添加错误处理
                tileset.readyPromise.then(function() {
                    // 成功加载时的处理
                    viewer.scene.primitives.add(tileset);
                    viewer.zoomTo(tileset);
                    showStatusMessage(`3D Tiles数据加载成功: ${fileName}`, 3000);
                    
                    modelType = 'tileset';
                    currentModel = tileset;
                }).catch(function(error) {
                    console.error('3D Tiles加载失败:', error);
                    // 提供具体的错误信息和解决方案
                    showStatusMessage('❌ 3D Tiles加载失败: ' + error.message, 5000);
                    
                    // 根据错误类型提供更具体的建议
                    if (error.message.includes('ERR_FILE_NOT_FOUND')) {
                        showStatusMessage('原因: 浏览器安全策略阻止了加载关联的本地资源文件(.i3dm, .b3dm等)', 8000);
                        showStatusMessage('解决方案1: 部署到Web服务器上运行（如localhost）', 8000);
                        showStatusMessage('解决方案2: 尝试使用glTF/glb格式，它们是独立文件格式', 8000);
                        showStatusMessage('解决方案3: 如果有所有相关文件，可以尝试使用允许本地文件访问的浏览器扩展', 8000);
                    }
                });
                
                // 添加场景级错误检测
                viewer.scene.preRender.addEventListener(function() {
                    if (tileset._error) {
                        console.error('场景渲染时检测到3D Tiles错误:', tileset._error);
                        // 仅显示一次错误消息
                        if (!tileset._errorReported) {
                            showStatusMessage('场景渲染错误: 无法加载3D Tiles关联资源', 5000);
                            tileset._errorReported = true;
                        }
                    }
                });
                
                // 设置超时处理
                setTimeout(function() {
                    if (!tileset.ready) {
                        showStatusMessage('3D Tiles加载超时，可能是因为浏览器安全限制', 5000);
                    }
                }, 10000);
                
                // 临时URL不会立即清理，以允许可能的延迟加载
                // 但会在30秒后尝试清理
                setTimeout(function() {
                    try {
                        URL.revokeObjectURL(fileUrl);
                    } catch (e) {
                        // 忽略清理错误
                    }
                }, 30000);
                
            } catch (error) {
                console.error('创建3D Tileset时发生错误:', error);
                showStatusMessage('创建3D Tileset失败: ' + error.message, 5000);
                
                // 清理临时URL
                try {
                    URL.revokeObjectURL(fileUrl);
                } catch (e) {
                    // 忽略清理错误
                }
            }
        }
        
        // 加载本地glTF/glb模型
        function loadLocalGlTFModel(fileUrl, fileName) {
            try {
                // 提示用户glTF是推荐格式
                showStatusMessage(`提示: glTF/glb是推荐的模型格式，无需额外依赖文件，可以直接完整显示。`, 5000);
                
                // 创建模型实体，增加更多配置参数确保正确显示
                const modelEntity = viewer.entities.add({
                    name: fileName,
                    position: Cesium.Cartesian3.fromDegrees(116.397, 39.907, 0), // 默认为北京坐标
                    model: {
                        uri: fileUrl,
                        scale: 1.0,
                        minimumPixelSize: 128,
                        maximumScale: 20000,
                        runAnimations: true,
                        incrementallyLoadTextures: true,
                        clampAnimations: true,
                        // 增加确保模型可见的参数
                        show: true,
                        allowPicking: true,
                        backFaceCulling: true,
                        debugWireframe: false,
                        colorBlendMode: Cesium.ColorBlendMode.HIGHLIGHT, // 确保颜色正确显示
                        color: Cesium.Color.WHITE.withAlpha(1.0) // 确保不透明，完全可见
                    }
                });
                
                modelType = 'model';
                currentModel = modelEntity;
                
                // 使用更可靠的定位方法
                try {
                    viewer.zoomTo(modelEntity, new Cesium.HeadingPitchRange(0, -0.5, 200));
                    showStatusMessage(`本地3D模型加载完成: ${fileName}`, 3000);
                } catch (zoomError) {
                    console.warn('定位到模型失败，尝试备用方法:', zoomError);
                    // 使用备用定位方法
                    setTimeout(() => {
                        try {
                            viewer.flyTo(modelEntity, {
                                duration: 2.0,
                                offset: new Cesium.HeadingPitchRange(0, -0.5, 200)
                            });
                        } catch (e) {
                            console.error('备用定位方法也失败:', e);
                        }
                    }, 500);
                }
                
                // 添加模型加载状态检查
                setTimeout(() => {
                    if (currentModel && currentModel.model && !currentModel.model.show) {
                        console.warn('模型可能未正确显示，尝试修复...');
                        currentModel.model.show = true;
                    }
                }, 2000);
                
            } catch (error) {
                console.error('加载本地glTF/glb模型失败:', error);
                showStatusMessage(`加载本地3D模型失败: ${error.message}`, 5000);
                if (currentModel) {
                    viewer.entities.remove(currentModel);
                }
                currentModel = null;
                modelType = null;
            }
        }
        
        // 样式选择事件
        document.getElementById('styleSelect').addEventListener('change', function() {
            applyStyle(this.value);
        });
        
        // 透明度滑块事件
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        
        opacitySlider.addEventListener('input', function() {
            opacityValue.textContent = this.value;
            if (tileset && modelType === 'tileset') {
                // 修复透明度设置，确保color属性正确初始化
                const opacity = parseFloat(this.value);
                if (tileset.style && tileset.style.color && tileset.style.color.alpha !== undefined) {
                    // 如果现有样式有color.alpha属性，直接修改
                    tileset.style.color.alpha = opacity;
                } else {
                    // 否则创建新的样式对象
                    const newStyle = new Cesium.Cesium3DTileStyle({
                        color: {
                            conditions: [
                                ['true', `vec4(1.0, 1.0, 1.0, ${opacity})`]
                            ]
                        }
                    });
                    tileset.style = newStyle;
                }
            } else if (modelType === 'model') {
                // 对于glTF模型，调整模型的透明度
                if (currentModel && currentModel.model) {
                    currentModel.model.color = new Cesium.Color(1.0, 1.0, 1.0, parseFloat(this.value));
                }
            }
        });
        
        // 应用样式函数
        function applyStyle(styleName) {
            if (!tileset || modelType !== 'tileset') {
                showStatusMessage('样式功能仅适用于3D Tiles模型', 2000);
                return;
            }
            
            try {
                let style;
                const opacity = parseFloat(opacitySlider.value);
                
                switch (styleName) {
                    case 'original':
                        style = originalStyle;
                        break;
                    case 'height':
                        style = new Cesium.Cesium3DTileStyle({
                            color: {
                                conditions: [
                                    ['${height} >= 200', `rgb(255, 0, 0, ${opacity})`],
                                    ['${height} >= 150', `rgb(255, 165, 0, ${opacity})`],
                                    ['${height} >= 100', `rgb(255, 255, 0, ${opacity})`],
                                    ['${height} >= 50', `rgb(0, 255, 0, ${opacity})`],
                                    ['true', `rgb(0, 0, 255, ${opacity})`]
                                ]
                            },
                            show: true
                        });
                        break;
                    case 'random':
                        style = new Cesium.Cesium3DTileStyle({
                            color: `rgb(Math.random() * 255, Math.random() * 255, Math.random() * 255, ${opacity})`,
                            show: true
                        });
                        break;
                    case 'highlight':
                        style = new Cesium.Cesium3DTileStyle({
                            color: `rgb(${selected ? '255, 255, 0' : '100, 100, 100'}, ${opacity})`,
                            show: true
                        });
                        break;
                    case 'transparent':
                        style = new Cesium.Cesium3DTileStyle({
                            color: `rgb(255, 255, 255, ${opacity})`,
                            show: true
                        });
                        opacitySlider.value = 0.3;
                        opacityValue.textContent = '0.3';
                        break;
                }
                
                tileset.style = style;
                showStatusMessage('样式已应用: ' + styleName, 2000);
            } catch (error) {
                console.error('应用样式失败:', error);
                showStatusMessage('应用样式失败', 2000);
            }
        }
        
        // 重置样式按钮
        document.getElementById('resetStyle').addEventListener('click', function() {
            if (tileset && modelType === 'tileset') {
                tileset.style = originalStyle;
                document.getElementById('styleSelect').value = 'original';
                opacitySlider.value = 1;
                opacityValue.textContent = '1.0';
                showStatusMessage('样式已重置', 2000);
            } else if (modelType === 'model') {
                showStatusMessage('样式功能仅适用于3D Tiles模型', 2000);
            }
        });
        
        // 处理鼠标点击事件，选择特征
        viewer.screenSpaceEventHandler.setInputAction(function(click) {
            if (!tileset || modelType !== 'tileset') {
                // 对于glTF模型，显示简单的点击信息
                if (modelType === 'model') {
                    const pickedObject = viewer.scene.pick(click.position);
                    if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
                        showStatusMessage(`点击了模型: ${pickedObject.id.name}`, 2000);
                    }
                }
                return;
            }
            
            const pickedFeature = viewer.scene.pick(click.position);
            
            if (Cesium.defined(pickedFeature) && Cesium.defined(pickedFeature.getProperty)) {
                // 清除之前的选择
                if (selectedFeature) {
                    selectedFeature.setProperty('selected', false);
                }
                
                // 设置新的选择
                selectedFeature = pickedFeature;
                pickedFeature.setProperty('selected', true);
                
                // 显示特征信息
                const featureInfo = [];
                const propertyNames = pickedFeature.getPropertyNames();
                for (let i = 0; i < propertyNames.length; i++) {
                    const propertyName = propertyNames[i];
                    const propertyValue = pickedFeature.getProperty(propertyName);
                    featureInfo.push(propertyName + ': ' + propertyValue);
                }
                
                showStatusMessage('选中特征: ' + featureInfo.join(', '), 5000);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        
        // 简单的错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('错误:', message, '行号:', lineno);
            try {
                showStatusMessage('发生错误，请刷新页面重试', 3000);
            } catch (e) {
                console.error('无法显示错误消息:', e);
            }
            return true;
        };
    </script>
</body>
</html>
